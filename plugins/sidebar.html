<script type="text/javascript">
(function() {
   var globalRefToSvgData;

   let obfuscateHelpers={getFlowDataFromCurrentWorkspace:e=>{var e=e||RED.workspaces.active(),t=RED.nodes.groups(e),e=(t=(t=t.concat(RED.nodes.junctions(e))).concat(RED.nodes.filterNodes({z:e})),RED.nodes.eachConfig(function(e){e.z===RED.workspaces.active()&&!1===e._def.hasUsers&&t.push(e)}),RED.nodes.workspace(e)||RED.nodes.subflow(e));return t.unshift(e),RED.nodes.createExportableNodeSet(t)},openImportDialog:e=>{RED.clipboard.import();let t=e;setTimeout(()=>{$("#red-ui-clipboard-dialog-import-text").val(JSON.stringify(t)).trigger("paste")},300)}};function obfuscatieCurrentFlow(l){let p=obfuscateHelpers.getFlowDataFromCurrentWorkspace(),f=(l.remove_groups&&(p=p.filter(e=>"group"!=e.type)).forEach(e=>{delete e.g}),{}),t={},d={},c={},s=[],h={},r={};if(p.forEach(e=>{"subflow"==(f[e.id]=e).type&&(r[e.id]=e),"junction"==e.type&&(t[e.id]=e),"link out"==e.type&&(c[e.id]=e),"link in"==e.type&&(d[e.id]=e),"link call"==e.type&&s.push(e.id),"catch"==e.type&&(h[e.id]=(e.wires||[])[0]||[])}),l.remove_junctions&&(Object.keys(t).forEach(n=>{let s=t[n];r[s.z]||p.forEach(t=>{for(let e=0;e<(t.wires||[]).length;e++){var r=t.wires[e].indexOf(n);-1<r&&(t.wires[e].splice(r,1),t.wires[e].push(...s.wires[0]))}})}),p=p.filter(e=>!("junction"==e.type&&!r[e.z]))),l.remove_linkout_nodes||l.remove_linkcall_nodes){let r=[],n=[],i=[],a=(l.remove_linkout_nodes&&!l.copy_linkin_nodes&&Object.keys(c).forEach(n=>{var e=c[n];let s=e.links||[];s.reduce((e,t)=>e&&(!!d[t]||l.ignore_off_flow_links),!0)&&"return"!=e.mode&&(r.push(n),p.forEach(r=>{for(let t=0;t<(r.wires||[]).length;t++){var e=r.wires[t].indexOf(n);-1<e&&(r.wires[t].splice(e,1),s.forEach(e=>{d[e]&&r.wires[t].push(...d[e].wires[0])}))}}))}),(s,e)=>{if(!e)return!1;let t=[],o=[],r=[];function u(e){if(r.indexOf(e.id)<0)switch(r.push(e.id),t.push(e),e.type){case"link out":if("return"!=e.mode)throw"not handable";break;case"link call":throw"unhandled";default:RED.nodes.getNodeLinks(e).forEach(function(e){u(e.target)})}}try{RED.nodes.getNodeLinks(e).forEach(function(e){u(e.target),o.push(e.target.id)});if(Object.keys(h).forEach(e=>{((t,e)=>{try{return e.map(e=>e.id).forEach(e=>{if(t.includes(e))throw"yes"}),!1}catch(e){return!0}})(h[e],t)&&t.push(f[e])}),0==t.length)return!1;let r={};var i=t[0];let n={x:s.x-i.x,y:s.y-i.y};var a=t.map(e=>{var t=structuredClone(f[e.id]);return t||console.log("WARNING: nodeid not found",[e.id,f[e.id]]),t.id=RED.nodes.id(),t.x+=n.x,t.y+=n.y,r[e.id]=t});return a.forEach(e=>{"catch"==e.type&&Array.isArray(e.scope)&&(e.scope=e.scope.map(e=>{var t=r[e];return t&&t.id||e})),e.wires&&(e.wires=e.wires.map(e=>e.map(e=>{var t=r[e];return t&&"link out"==t.type?[...s.wires[0],(t||{}).id||e]:(t||{}).id||e}).flat()))}),{nodes:a.filter(e=>"link out"!=e.type),entryNodes:o.map(e=>r[e])}}catch(e){return!1}});l.remove_linkout_nodes&&l.copy_linkin_nodes&&Object.keys(c).forEach(s=>{let o=c[s],u=o.links||[];if("return"!=o.mode){let t=u.map(e=>{var t=d[e],t=a(o,t);return t?[e,t]:[void 0,void 0]});t.reduce((e,t)=>e&&(!!t[0]||l.ignore_off_flow_links),!0)&&(r.push(s),p.forEach(n=>{for(let r=0;r<(n.wires||[]).length;r++){var e=n.wires[r].indexOf(s);-1<e&&(n.wires[r].splice(e,1),(t=u.map(e=>{var t=d[e],t=a(o,t);return t?[e,t]:[void 0,void 0]})).forEach(([,e])=>{var t;e&&(t=e.entryNodes.map(e=>e.id),n.wires[r].push(...t),i.push(...e.nodes))}))}}))}}),l.remove_linkcall_nodes&&s.forEach(s=>{var e=f[s],t=d[e.links[0]];let o=a(e,t);t&&o&&(n.push(e.id),p.forEach(t=>{for(let e=0;e<(t.wires||[]).length;e++){var r,n=t.wires[e].indexOf(s);-1<n&&(r=o.entryNodes.map(e=>e.id),t.wires[e].splice(n,1),t.wires[e].push(...r),i.push(...o.nodes))}}))}),(p=p.filter(e=>r.indexOf(e.id)<0&&n.indexOf(e.id)<0)).push(...i)}if((p=l.remove_debugs?p.filter(e=>"debug"!=e.type&&"comment"!=e.type):p).forEach(e=>{l.name&&(e.name=RED.nodes.id()),l.shrink_node&&(e.l=!1),l.info&&(e.info="",delete e.outputLabels,delete e.inputLabels),l.add_license&&(l.append_license?e.info=(e.info||"")+"\n---\n\n"+l.license_text:e.info=l.license_text),l.position&&(e.x=150,e.y=150),l.remove_icons&&delete e.icon}),l.replace_switch){let n=(t,r)=>{for(let e=0;e<r.rules.length;e++){var n=r.rules[e];if("nnull"==n.t)t.push("if ( _propValue != null ) {  _returnValue.push(msg) ; return node.send(_returnValue) } else { _returnValue.push(undefined) }");else if("null"==n.t)t.push("if ( _propValue == null ) {  _returnValue.push(msg) ; return node.send(_returnValue) } else { _returnValue.push(undefined) }");else if("eq"==n.t&&"str"==n.vt){s=n.v;s=btoa(encodeURIComponent(s).replace(/%([0-9A-F]{2})/g,function(e,t){return String.fromCharCode("0x"+t)}));t.push("if ( _propValue === Buffer.from('"+s+"', 'base64').toString('utf-8') ) {  _returnValue.push(msg) ; return node.send(_returnValue) } else { _returnValue.push(undefined) }")}else if("gt"==n.t&&"num"==n.vt)t.push("if ( _propValue > "+n.v+" ) {  _returnValue.push(msg) ; return node.send(_returnValue) } else { _returnValue.push(undefined) }");else if("eq"==n.t&&"num"==n.vt)t.push("if ( _propValue == "+n.v+" ) {  _returnValue.push(msg) ; return node.send(_returnValue) } else { _returnValue.push(undefined) }");else if("empty"==n.t)t.push('let p = _propValue ;  if (  (Array.isArray(p) && p.length == 0) || ((typeof p === "object") && p != null && Object.keys(p).length == 0) || ((typeof p === "string") && p.length == 0) ) { _returnValue.push(msg) ; return node.send(_returnValue) } else {  _returnValue.push(undefined) }');else if("nempty"==n.t)t.push('let p = _propValue ;  if (  (Array.isArray(p) && p.length > 0) || ((typeof p === "object") && p != null && Object.keys(p).length > 0) || ((typeof p === "string") && p.length > 0) ) { _returnValue.push(msg) ; return node.send(_returnValue) } else {  _returnValue.push(undefined) }');else{if("else"!=n.t)throw"unhandled";t.push("_returnValue.push(msg)","return node.send(_returnValue)")}}var s};p=p.map(t=>{if("switch"!=t.type)return t;var e={id:t.id,name:t.name,type:"function",x:t.x,y:t.y,func:"",outputs:t.outputs,timeout:"",noerr:0,initialize:"",finalize:"",libs:[{var:"process",module:"process"},{var:"jsonata",module:"jsonata"}],wires:t.wires};t.hasOwnProperty("z")&&(e.z=t.z),t.hasOwnProperty("l")&&(e.l=t.l);try{var r=[];if(t.checkAll)throw"unhandled";if("msg"==t.propertyType)r.push("((msg,node) => {","let _propValue = undefined","try { _propValue = RED.util.getMessageProperty(msg, '"+t.property+"') } catch (ex) {}","let _returnValue = []"),n(r,t),r.push("})(msg,node);");else{if("jsonata"!=t.propertyType)throw"unhandled";r.push("jsonata('"+t.property+"').evaluate(msg).then(_propValue => {","let _returnValue = []"),n(r,t),r.push("})")}return e.func=r.join("\n"),e}catch(e){return t}})}if(l.replace_change){let s=e=>btoa(encodeURIComponent(e).replace(/%([0-9A-F]{2})/g,function(e,t){return String.fromCharCode("0x"+t)}));p=p.map(t=>{if("change"!=t.type)return t;var e={id:t.id,name:t.name,type:"function",x:t.x,y:t.y,func:"",outputs:1,timeout:"",noerr:0,initialize:"",finalize:"",libs:[{var:"process",module:"process"},{var:"jsonata",module:"jsonata"}],wires:t.wires};t.hasOwnProperty("z")&&(e.z=t.z),t.hasOwnProperty("l")&&(e.l=t.l);try{var r=["(async (msg,node) => {","let __s = RED.util.setMessageProperty","let __g = RED.util.getMessageProperty"];for(let e=0;e<t.rules.length;e++){var n=t.rules[e];if("set"==n.t){if(n.dc)throw"unhandled";if("msg"==n.pt&&"str"==n.tot)r.push("__s(msg,'"+n.p+"', Buffer.from('"+s(n.to)+"', 'base64').toString('utf-8') )");else if("msg"==n.pt&&"bool"==n.tot)r.push("__s(msg,'"+n.p+"', "+n.to+")");else if("msg"==n.pt&&"num"==n.tot)r.push("__s(msg,'"+n.p+"', Number(Buffer.from('"+s(n.to)+"', 'base64').toString('utf-8')))");else if("msg"==n.pt&&"json"==n.tot)r.push("__s(msg,'"+n.p+"', JSON.parse(Buffer.from('"+s(n.to)+"', 'base64').toString('utf-8')))");else if("msg"==n.pt&&"msg"==n.tot)r.push("try { __s(msg,'"+n.p+"',  __g(msg, '"+n.to+"')) } catch (ex) {}");else if("msg"==n.pt&&"env"==n.tot)r.push("__s(msg,'"+n.p+"',  process.env['"+n.to+"'])");else{if("msg"!=n.pt||"jsonata"!=n.tot||!n.to.startsWith("/* @obfuscate-safe */"))throw"unhandlable";r.push("__s(msg,'"+n.p+"',  await jsonata(Buffer.from('"+s(n.to)+"', 'base64').toString('utf-8')).evaluate(msg) )")}}else{if("delete"!=n.t||"msg"!=n.pt)throw"unhandlable";r.push("delete msg."+n.p)}}return r.push("node.send(msg) })(msg,node);"),e.func=r.join("\n"),e}catch(e){return console.log(e),t}})}if(l.javascript){let r={},t=[];p.forEach(e=>{"javascript"!=(r[e.id]=e).format&&"function"!=e.type&&"css"!=e.format&&"json"!=e.format||t.push(e)});var e={parse:{bare_returns:!0,expression:!1},compress:{},mangle:{reserved:["$","export","require"]},output:null,sourceMap:null,nameCache:null,toplevel:!1,warnings:!1},o={compatibility:"*",level:2};$.ajax({url:"ClientCode/"+RED.nodes.id()+"/ugify",type:"POST",contentType:"application/json; charset=utf-8",data:JSON.stringify({nodes:t,jscfg:e,csscfg:o}),success:function(e){e.forEach(e=>{var t=r[e.id];e._error&&console.log("ERROR NODE",e),"function"==t.type?t.func=e.func:"javascript"!=t.format&&"css"!=t.format&&"json"!=t.format||(t.template=e.template)}),obfuscateHelpers.openImportDialog(p)},error:function(e,t,r){RED.notify("ClientCode Communcation Failure: "+n.id+": "+t,{type:"error",timeout:3e3})}})}else obfuscateHelpers.openImportDialog(p)}
   
   function setupTreelist(){var e=collectOrphans();if(0==e.length){RED.notify("No Orphans Found",{type:"success",timeout:2e3});try{$("#node-input-orphan-target-container-div").treeList("empty")}catch(e){}}else{try{$("#node-input-orphan-target-container-div").treeList("empty")}catch(e){$("#node-input-orphan-target-container-div").css({width:"100%",height:"calc(100%)"}).treeList({multi:!1}).on("treelistitemmouseover",function(e,t){}).on("treelistitemmouseout",function(e,t){}).on("treelistselect",function(e,t){t.node&&(RED.workspaces.show(t.node.z,!1,!1,!0),RED.view.reveal(t.node.id,!0),RED.view.redraw())}).on("treelistconfirm",function(e,t){var n;t.node&&(n=t.node.id,setTimeout(()=>{var e=RED.nodes.node(n);e&&(RED.view.reveal(e.id),RED.view.select(e.id),RED.editor.edit(e)),n==RED.workspaces.active()&&RED.workspaces.edit()},50))}),$("#node-input-orphan-target-filter").show();var n=$("#node-input-orphan-target-filter").searchBox({style:"compact",delay:300,change:function(){var e,t=$(this).val().trim().toLowerCase();""===t?($("#node-input-orphan-target-container-div").treeList("filter",null),n.searchBox("count","")):(e=$("#node-input-orphan-target-container-div").treeList("filter",function(e){return-1<e.label.toLowerCase().indexOf(t)||-1<e.node.type.toLowerCase().indexOf(t)}),n.searchBox("count",e+" / "+$("#node-input-orphan-target-container-div").treeList("data").length))}})}$("#node-input-orphan-target-container-div").treeList("data",e.sort((e,t)=>e.node.z>t.node.z))}}function collectOrphans(){let t=new Set;var n=[],i=(RED.nodes.eachLink(e=>{t.add(e.source),t.add(e.target)}),RED.nodes.eachNode(e=>{(!t.has(e)||"link out"==e.type&&"link"==e.mode&&0==e.links.reduce((e,t)=>e||!!RED.nodes.node(t),!1))&&n.push(e)}),[]),r={};return n.forEach(function(e){var t=RED.nodes.getType(e.type);if(t){var n=t.label,n=("function"==typeof n?n.call(e):n)||"",o=e.type;if(0===o.indexOf("subflow:"))return}t&&n||(n=e.type),r[e.id]={node:e,label:n,sublabel:o,selected:!1,checkbox:!1},i.push(r[e.id])}),i}
   
   function nr_intro_generate_svg_4_1(r,t){return e=>{try{handleSvgObject($($("#red-ui-workspace-chart").find("svg")[0]),e,t)}catch(t){var n="Error Generating SVG: "+JSON.stringify(t);r.notify(n,{type:"error"}),e('<?xml version="1.0" encoding="UTF-8" standalone="no"?><svg width="1000" height="1000" viewBox="0 0 1000 1000" pointer-events="all" style="cursor: crosshair; touch-action: none;" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><style>.small { font: bold 20px sans-serif; fill: red;}</style><text x="10" y="30" class="small">'+n+"</text></svg>")}}}function nr_intro_generate_svg_4_0(r,t){return e=>{try{handleSvgObject($($("#red-ui-workspace-chart").find("svg")[0]),e,t)}catch(t){var n="Error Generating SVG: "+JSON.stringify(t);r.notify(n,{type:"error"}),e('<?xml version="1.0" encoding="UTF-8" standalone="no"?><svg width="1000" height="1000" viewBox="0 0 1000 1000" pointer-events="all" style="cursor: crosshair; touch-action: none;" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><style>.small { font: bold 20px sans-serif; fill: red;}</style><text x="10" y="30" class="small">'+n+"</text></svg>")}}}function nr_intro_generate_svg_3_1(r,t){return e=>{try{handleSvgObject($($("#red-ui-workspace-chart").find("svg")[0]),e,t)}catch(t){var n="Error Generating SVG: "+JSON.stringify(t);r.notify(n,{type:"error"}),e('<?xml version="1.0" encoding="UTF-8" standalone="no"?><svg width="1000" height="1000" viewBox="0 0 1000 1000" pointer-events="all" style="cursor: crosshair; touch-action: none;" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><style>.small { font: bold 20px sans-serif; fill: red;}</style><text x="10" y="30" class="small">'+n+"</text></svg>")}}}function nr_intro_generate_svg_3_0(r,t){return e=>{try{handleSvgObject($($("svg")[0]),e,t)}catch(t){var n="Error Generating SVG: "+JSON.stringify(t);r.notify(n,{type:"error"}),e('<?xml version="1.0" encoding="UTF-8" standalone="no"?><svg width="1000" height="1000" viewBox="0 0 1000 1000" pointer-events="all" style="cursor: crosshair; touch-action: none;" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><style>.small { font: bold 20px sans-serif; fill: red;}</style><text x="10" y="30" class="small">'+n+"</text></svg>")}}}function handleSvgObject(o,t,e){var n=o.clone(),r=(e.removeforeignobjects&&n.find("foreignObject").remove(),n.find("svg.__screenshot").remove(),'width="'+o.attr("width")+'" height="'+o.attr("height")+'"'),s=RED.settings.version.split("."),i=parseInt(s[0]),s=parseInt(s[1]);if(3<=i&&1<=s||4<=i){var a=$($($(o).children("g")[0]).children("g")[0]).children("g"),l={x:8e3,y:8e3,w:-1,h:-1};for(let t=1;t<a.length;t++){var g=a[t].getBBox();0==g.width&&0==g.height||(l.x=Math.min(g.x,l.x),l.y=Math.min(g.y,l.y),l.w=Math.max(g.width,l.w),l.h=Math.max(g.height,l.h))}r+=` viewBox='${l.x} ${l.y} ${l.w} ${l.h}'`}function c(t,e){for(var n=0;n<t.length;n++){var s=t.item(n),i=e[n];["stroke-width","fill-opacity","stroke-opacity","opacity","stroke-dasharray"].forEach(function(t){s.setAttribute(t,$(i).attr(t)||$(i).css(t))}),["fill","stroke"].forEach(function(t){var e,n,r=(e=$(i).attr(t)||$(i).css(t))&&null!==e&&"none"!=e?(n=e.match(/^#(.)(.)(.)$/))?"#"+n[1]+n[1]+n[2]+n[2]+n[3]+n[3]:(n=e.match(/^#......$/))?e:null===(n=e.match(/^rgb\(([0-9]+),\s+([0-9]+),\s+([0-9]+)/))?(r=e.match(/^rgba\(([0-9]+),\s+([0-9]+),\s+([0-9]+),\s+([0-9]+)/))?{clr:"#"+("0"+parseInt(r[1],10).toString(16)).slice(-2)+("0"+parseInt(r[2],10).toString(16)).slice(-2)+("0"+parseInt(r[3],10).toString(16)).slice(-2),opa:r[4]}:(console.log("Screenshot node: returned unknown color: "+e),e):"#"+("0"+parseInt(n[1],10).toString(16)).slice(-2)+("0"+parseInt(n[2],10).toString(16)).slice(-2)+("0"+parseInt(n[3],10).toString(16)).slice(-2):"none";"object"==typeof r?(s.setAttribute(t+"-opacity",r.opa),s.setAttribute(t,r.clr)):s.setAttribute(t,r)}),$(i).hasClass("hide")&&("g"==s.tagName&&s.setAttribute("opacity","0"),s.setAttribute("visibility","hidden"))}}var s='<?xml version="1.0" standalone="no"?>\r\n<svg '+r+' pointer-events="all" style="cursor: crosshair; touch-action: none;" xmlns="http://www.w3.org/2000/svg" class="__screenshot" xmlns:xlink="http://www.w3.org/1999/xlink">\r\n',i=n.html(),h=(new DOMParser).parseFromString(s+i+"\r\n</svg>","image/svg+xml"),v=t=>t,f=(e.rmidsandclasses&&(v=e=>(["g","rect","line","path","circle","image","text"].forEach(t=>{$(e.getElementsByTagName(t)).each((t,e)=>{e.setAttribute("class",""),e.setAttribute("id","")})}),e)),["g","rect","line","path","circle","image"].forEach(function(t){c(h.getElementsByTagName(t),o.find(t))}),["text"].forEach(function(t){c(h.getElementsByTagName(t),o.find(t));for(var e=h.getElementsByTagName(t),n=o.find(t),r=0;r<e.length;r++){var s=e.item(r),i=n[r];["font-family","font-size","font-size-adjust","font-stretch","font-style","font-variant","font-weight","text-anchor","dominant-baseline"].forEach(function(t){s.setAttribute(t,$(i).attr(t)||$(i).css(t))})}}),h.getElementsByTagName("image")),w={},d=(n,r,s)=>{var i=n.getAttribute("xlink:href")||n.getAttribute("href"),o=i.substr(-4,4).toLowerCase(),a={".jpg":"jpeg",jpeg:"jpeg",".png":"png",".svg":"svg+xml"};if(w[i])return n.setAttribute("xlink:href","data:image/"+a[o]+";base64,"+w[i]),s(r-1);switch(o){case".jpg":case"jpeg":case".png":var l=new XMLHttpRequest;l.open("GET",i,!0),l.responseType="arraybuffer";l.onerror=function(t){s(r-1)},l.onload=function(t){var e=l.response;e&&(e=(t=>{for(var e="",n=new Uint8Array(t),r=n.byteLength,s=0;s<r;s++)e+=String.fromCharCode(n[s]);return window.btoa(e)})(e),w[i]=e,n.setAttribute("xlink:href","data:image/"+a[o]+";base64,"+e)),s(r-1)},l.send(null);break;case".svg":$.get(i,function(t){var e=new XMLSerializer,e=btoa(e.serializeToString(t));w[i]=e,n.setAttribute("xlink:href","data:image/svg+xml;base64,"+e),s(r-1)});break;default:console.log("SVG Capture ignoring file prefix: "+o),s(r-1)}},m=e=>{if(e<0)t((new XMLSerializer).serializeToString(v(h)));else try{d(f.item(e),e,m)}catch(t){m(e-1)}};0<f.length?d(f.item(f.length-1),f.length-1,m):t((new XMLSerializer).serializeToString(v(h)))}function generatorFunctionForVersion(t,e){var n,r=t.settings.version.split("."),s=r[0],r=r[1];if("3"==s){if("0"==r)return nr_intro_generate_svg_3_0(t,e);if("1"==r)return nr_intro_generate_svg_3_1(t,e)}if("4"==s){if("0"==r)return nr_intro_generate_svg_4_0(t,e);if("1"==r)return nr_intro_generate_svg_4_1(t,e)}return n=t,t=>{var e="Node-RED version ("+n.settings.version+") not supported";n.notify(e,{type:"error"}),t&&t('<?xml version="1.0" encoding="UTF-8" standalone="no"?><svg width="1000" height="1000" viewBox="0 0 1000 1000" pointer-events="all" style="cursor: crosshair; touch-action: none;" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><style>.small { font: bold 20px sans-serif; fill: red;}</style><text x="10" y="30" class="small">'+e+"</text></svg>")}}function addPanZoom(){var t=d3.select("#node-input-screenshot-svgcontainer svg"),e=(t.html("<g>"+t.html()+"</g>"),setTimeout(()=>{var t=$("#node-input-screenshot-svgcontainer svg"),e=$(t).attr("viewBox").split(" ");t.animate({height:parseInt(e[3]),width:parseInt(e[2])},800,"swing")},100),t.select("g")),n=d3.behavior.zoom().scaleExtent([.1,200]).on("zoom",function(t){e.attr({transform:"translate("+n.translate()+") scale("+n.scale()+")"})});t.call(n)}

   function setupTreelistInfoness(){var e=collectUndocumentedNodes();if(0==e.length){RED.notify("All nodes documented",{type:"success",timeout:2e3});try{$("#node-input-orphan-target-container-div").treeList("empty")}catch(e){}}else{try{$("#node-input-orphan-target-container-div").treeList("empty")}catch(e){$("#node-input-orphan-target-container-div").css({width:"100%",height:"calc(100%)"}).treeList({multi:!1}).on("treelistitemmouseover",function(e,t){}).on("treelistitemmouseout",function(e,t){}).on("treelistselect",function(e,t){t.node&&(RED.workspaces.show(t.node.z,!1,!1,!0),RED.view.reveal(t.node.id,!0),RED.view.redraw())}).on("treelistconfirm",function(e,t){var i;t.node&&(i=t.node.id,setTimeout(()=>{var e=RED.nodes.node(i);e&&(RED.view.reveal(e.id),RED.view.select(e.id),RED.editor.edit(e,"editor-tab-description")),i==RED.workspaces.active()&&RED.workspaces.edit()},50))}),$("#node-input-orphan-target-filter").show();var i=$("#node-input-orphan-target-filter").searchBox({style:"compact",delay:300,change:function(){var e,t=$(this).val().trim().toLowerCase();""===t?($("#node-input-orphan-target-container-div").treeList("filter",null),i.searchBox("count","")):(e=$("#node-input-orphan-target-container-div").treeList("filter",function(e){return-1<e.label.toLowerCase().indexOf(t)||-1<e.node.type.toLowerCase().indexOf(t)}),i.searchBox("count",e+" / "+$("#node-input-orphan-target-container-div").treeList("data").length))}})}$("#node-input-orphan-target-container-div").treeList("data",e.sort((e,t)=>e.node.z>t.node.z))}}function collectUndocumentedNodes(){let t=[];RED.nodes.eachNode(e=>{if($("#"+e.id).find(".red-ui-info-available-indicator").remove(),e.info&&e.info.trim()&&$("#"+e.id)[0]){var i=document.createElementNS("http://www.w3.org/2000/svg","g"),n=(i.setAttribute("class","red-ui-info-available-indicator"),i.setAttribute("transform","translate(20,10)"),i.setAttribute("id","infoclk-"+e.id),document.createElementNS("http://www.w3.org/2000/svg","g")),o=(n.setAttribute("class","tip"),n.setAttribute("fill","lightyellow"),document.createElementNS("http://www.w3.org/2000/svg","rect")),o=(o.setAttribute("width","30"),o.setAttribute("height","20"),o.setAttribute("x",$("#"+e.id)[0].getBBox().width-60),o.setAttribute("y","-15"),o.setAttribute("rx","2"),o.setAttribute("style","cursor: pointer;"),n.append(o),document.createElementNS("http://www.w3.org/2000/svg","text"));o.setAttribute("x",$("#"+e.id)[0].getBBox().width-55),o.setAttribute("y","-6"),o.appendChild(document.createTextNode("docs")),n.append(o),i.append(n),$(i).insertBefore($("#"+e.id).find(".red-ui-flow-node"));let t=e.id;$("#infoclk-"+e.id).on("click",e=>{e&&e.preventDefault();e=RED.nodes.node(t);RED.editor.edit(e,"editor-tab-description"),RED.sidebar.show("info")})}else e.z==RED.workspaces.active()&&["link in","link out","link call"].indexOf(e.type)<0&&t.push(e)});var o=[],r={};return t.forEach(function(e){var t=RED.nodes.getType(e.type);if(t){var i,n=t.label,n=("function"==typeof n?n.call(e):n)||"";if(0===(i=e.type).indexOf("subflow:"))return}t&&n||(n=e.type),r[e.id]={node:e,label:n,sublabel:i,selected:!1,checkbox:!1},o.push(r[e.id])}),o}

   function highlightAllLinkCalls(){let e=[];RED.nodes.eachNode(t=>{t.z==RED.workspaces.active()&&"link call"==t.type&&e.push(t)}),e.forEach(t=>{$("#grplnkcallclk-"+t.id).remove();var e=document.createElementNS("http://www.w3.org/2000/svg","g"),l=(e.setAttribute("class","red-ui-linkcall-link-indicator"),e.setAttribute("transform","translate(12,0)"),e.setAttribute("id","grplnkcallclk-"+t.id),document.createElementNS("http://www.w3.org/2000/svg","circle")),i=(l.setAttribute("cx","5"),l.setAttribute("cy","5"),l.setAttribute("r","5"),l.setAttribute("id","lnkcallclk-"+t.id),l.setAttribute("style","cursor: pointer;"),t.links[0]);i?RED.nodes.node(i)?l.setAttribute("fill","green"):l.setAttribute("fill","red"):l.setAttribute("fill","orange"),e.append(l),$(e).insertBefore($("#"+t.id).find(".red-ui-flow-node-changed"));let r=t.id;$("#lnkcallclk-"+t.id).on("click",t=>{t&&t.preventDefault();t=RED.nodes.node(r);if(t){let l=t.links[0];1<t.links.length&&RED.notify("Multiple links, showing first","warning"),RED.nodes.node(l)?(RED.view.reveal(l),RED.view.select(l),setTimeout(()=>{$("#lnkcallclk-"+l).remove();var t=document.createElementNS("http://www.w3.org/2000/svg","g"),e=(t.setAttribute("class","red-ui-linkcall-link-indicator"),t.setAttribute("transform","translate(12,0)"),t.setAttribute("id","lnkcallclk-"+l),document.createElementNS("http://www.w3.org/2000/svg","circle"));e.setAttribute("cx","5"),e.setAttribute("cy","5"),e.setAttribute("r","5"),e.setAttribute("id","lnkcallclk-"+l),e.setAttribute("style","cursor: pointer;"),e.setAttribute("fill","green"),t.append(e),$(t).insertBefore($("#"+l).find(".red-ui-flow-node-changed")),$("#lnkcallclk-"+l).on("click",t=>{t&&t.preventDefault(),RED.view.reveal(r),RED.view.select(r),setTimeout(highlightAllLinkCalls,500)})},500)):RED.notify("Link in node not found","error")}else RED.notify("Node not found","error")})})}

   function setupTreelistAllLinksForLinkIn(e){e=collectAllLinksNodes(e);if(0==e.length){RED.notify("No links found",{type:"error",timeout:2e3});try{$("#node-input-orphan-target-container-div").treeList("empty")}catch(e){}}else{try{$("#node-input-orphan-target-container-div").treeList("empty")}catch(e){$("#node-input-orphan-target-container-div").css({width:"100%",height:"calc(100%)"}).treeList({multi:!1}).on("treelistitemmouseover",function(e,t){}).on("treelistitemmouseout",function(e,t){}).on("treelistselect",function(e,t){t.node&&(RED.workspaces.show(t.node.z,!1,!1,!0),RED.view.reveal(t.node.id,!0),RED.view.redraw())}).on("treelistconfirm",function(e,t){var n;t.node&&(n=t.node.id,setTimeout(()=>{var e=RED.nodes.node(n);e&&(RED.view.reveal(e.id),RED.view.select(e.id),RED.editor.edit(e,"editor-tab-description")),n==RED.workspaces.active()&&RED.workspaces.edit()},50))}),$("#node-input-orphan-target-filter").show();var n=$("#node-input-orphan-target-filter").searchBox({style:"compact",delay:300,change:function(){var e,t=$(this).val().trim().toLowerCase();""===t?($("#node-input-orphan-target-container-div").treeList("filter",null),n.searchBox("count","")):(e=$("#node-input-orphan-target-container-div").treeList("filter",function(e){return-1<e.label.toLowerCase().indexOf(t)||-1<e.node.type.toLowerCase().indexOf(t)}),n.searchBox("count",e+" / "+$("#node-input-orphan-target-container-div").treeList("data").length))}})}$("#node-input-orphan-target-container-div").treeList("data",e.sort((e,t)=>e.node.z>t.node.z))}}function collectAllLinksNodes(t){let n=[];RED.nodes.eachNode(e=>{"link call"!=e.type&&"link out"!=e.type||-1<e.links.indexOf(t)&&n.push(e)});var i=[],r={};return n.forEach(function(e){var t=RED.nodes.getType(e.type);if(t){var n,o=t.label,o=("function"==typeof o?o.call(e):o)||"";if(0===(n=e.type).indexOf("subflow:"))return}t&&o||(o=e.type),r[e.id]={node:e,label:o,sublabel:n,selected:!1,checkbox:!1},i.push(r[e.id])}),i}function collectNodeStats(){let t={},n=[],o={workspaces:0,junctions:0,subflows:0,configs:0,groups:0,wires:0,nodes:0},i=(RED.nodes.eachConfig(e=>{o.configs+=1}),RED.nodes.eachLink(e=>{o.wires+=1}),RED.nodes.eachJunction(e=>{o.junctions+=1}),RED.nodes.eachGroup(e=>{o.groups+=1}),RED.nodes.eachWorkspace(e=>{o.workspaces+=1}),RED.nodes.eachSubflow(e=>{o.subflows+=1}),RED.nodes.eachNode(e=>{o.nodes+=1,t[e.type]=(t[e.type]||0)+1}),Object.keys(t).forEach(e=>{n.push({label:e,sublabel:t[e],selected:!1,checkbox:!1})}),[]),r=0;return Object.keys(o).forEach(e=>{r+=o[e],i.push({label:e,sublabel:o[e],selected:!1,checkbox:!1})}),[{label:"__ TOTALS",sublabel:r,selected:!1,checkbox:!1,children:i}].concat(n.sort((e,t)=>e.label>t.label))}function setupTreeListForNodeStats(){var e=collectNodeStats();try{$("#node-input-orphan-target-container-div").treeList("empty")}catch(e){$("#node-input-orphan-target-container-div").css({width:"100%",height:"calc(100%)"}).treeList({multi:!1}).on("treelistitemmouseover",function(e,t){}).on("treelistitemmouseout",function(e,t){}).on("treelistselect",function(e,t){}).on("treelistconfirm",function(e,t){}),$("#node-input-orphan-target-filter").show();var n=$("#node-input-orphan-target-filter").searchBox({style:"compact",delay:300,change:function(){var e,t=$(this).val().trim().toLowerCase();""===t?($("#node-input-orphan-target-container-div").treeList("filter",null),n.searchBox("count","")):(e=$("#node-input-orphan-target-container-div").treeList("filter",function(e){return-1<e.label.toLowerCase().indexOf(t)}),n.searchBox("count",e+" / "+$("#node-input-orphan-target-container-div").treeList("data").length))}})}$("#node-input-orphan-target-container-div").treeList("data",e)}

   function setupTreeMsgTracerlist(){try{$("#node-input-msgtracer-trace-treelist").treeList("empty"),$("#node-input-msgtracer-trace-treelist").treeList("data",[])}catch(e){$("#node-input-msgtracer-trace-treelist").css({width:"100%",height:"calc(100%)"}).treeList({multi:!1}).on("treelistitemmouseover",function(e,t){}).on("treelistitemmouseout",function(e,t){}).on("treelistselect",function(e,t){t.node&&(RED.workspaces.show(t.node.z,!1,!1,!0),RED.view.reveal(t.node.id,!0),RED.view.redraw(),$("#node-input-msgtracer-toggle").is(":checked")||($(".red-ui-debug-msg").css("background-color",""),$(".red-ui-debug-msg-node-"+t.node.id).css("background-color","red")))}).on("treelistconfirm",function(e,t){var o;t.node&&(o=t.node.id,setTimeout(()=>{var e=RED.nodes.node(o);e&&(RED.view.reveal(e.id),RED.view.select(e.id),RED.editor.edit(e)),o==RED.workspaces.active()&&RED.workspaces.edit()},50))}),$("#node-input-msgtracer-trace-treelist-filter").show();var o=$("#node-input-msgtracer-trace-treelist-filter").searchBox({style:"compact",delay:300,change:function(){var e,t=$(this).val().trim().toLowerCase();""===t?($("#node-input-msgtracer-trace-treelist").treeList("filter",null),o.searchBox("count","")):(e=$("#node-input-msgtracer-trace-treelist").treeList("filter",function(e){return-1<e._label.toLowerCase().indexOf(t)||-1<e.node.type.toLowerCase().indexOf(t)||-1<e.node.id.toLowerCase().indexOf(t)||-1<e.sublabel.toLowerCase().indexOf(t)}),o.searchBox("count",e+" / "+$("#node-input-msgtracer-trace-treelist").treeList("data").length))}})}}function toggleDebugTracingInBackend(e){let t=$("#node-input-msgtracer-msgtodebug").is(":checked");var o=$("#node-input-msgtracer-msgtodebug-all").is(":checked"),r=RED.view.selection().nodes;r||o||!t?r&&0<r.length&&o&&t?($("#node-input-msgtracer-msgtodebug").prop("checked",!1),$("#node-input-msgtracer-msgtodebug-all").prop("checked",!1),RED.notify("Debug Messages not toggled, both nodes selected and all nodes is on.",{type:"error",timeout:3e3})):(t||$("#node-input-msgtracer-msgtodebug-all").prop("checked",!1),$.ajax({url:"MsgTracer/debug/"+(t?"on":"off"),type:"POST",contentType:"application/json; charset=utf-8",data:JSON.stringify({nodesSelected:(RED.view.selection().nodes||[]).map(e=>e.id),allIsOn:o}),success:function(e){RED.notify("Message debugging is <b>"+(t?"on":"off")+"</b>",{type:"success",timeout:3e3})},error:function(e,t,o){RED.notify("Message tracing failed: "+t,{type:"error",timeout:3e3})}})):($("#node-input-msgtracer-msgtodebug").prop("checked",!1),RED.notify("Debug Messages not toggled, first select nodes to be debugged <b>or</b> toggle 'all nodes' to on.",{type:"error",timeout:3e3}))}function toggleMsgTracingInBackend(e){let t=$("#node-input-msgtracer-toggle").is(":checked");var o=$("#node-input-msgtracer-toggle-all").is(":checked"),r=RED.view.selection().nodes;r||o||!t?r&&0<r.length&&o&&t?($("#node-input-msgtracer-toggle-all").prop("checked",!1),$("#node-input-msgtracer-toggle").prop("checked",!1),RED.notify("Message tracing not toggled, nodes are selected <b>and</b> all nodes is checked.",{type:"error",timeout:3e3})):(t||$("#node-input-msgtracer-toggle-all").prop("checked",!1),t&&setupTreeMsgTracerlist(),$.ajax({url:"MsgTracer/msgtracing/"+(t?"on":"off"),type:"POST",contentType:"application/json; charset=utf-8",data:JSON.stringify({nodesSelected:(RED.view.selection().nodes||[]).map(e=>e.id),allIsOn:o}),success:function(e){RED.notify("Message tracing is <b>"+(t?"on":"off")+"</b>",{type:"success",timeout:3e3})},error:function(e,t,o){RED.notify("Message tracing failed: "+t,{type:"error",timeout:3e3})}})):($("#node-input-msgtracer-toggle").prop("checked",!1),RED.notify("Message tracing not toggled, first select nodes to be traced <b>or</b> toggle 'all nodes' to on.",{type:"error",timeout:3e3}))}

   function transformInjectToChangeNode(t){t&&t.preventDefault();t=[...(RED.view.selection().nodes||[]).filter(e=>"inject"==e.type),...(RED.view.selection().nodes||[]).filter(e=>"group"==e.type).map(e=>e.nodes.filter(e=>"inject"==e.type))].flat();if(0==(t=RED.nodes.createExportableNodeSet(t)).length)RED.notify("No inject nodes found in node selection",{type:"warning"});else{let e=t.map(o=>{var e={id:RED.nodes.id(),type:"change",name:o.name,action:"",property:"",from:"",to:"",reg:!1,x:0,y:0,wires:[[]]};return e.rules=o.props.map(e=>{var t={t:"set",p:e.p,pt:"msg",to:e.v,tot:e.vt};return"payload"==e.p?(t.to=o.payload,t.tot=o.payloadType):"topic"==e.p&&(t.to=o.topic),t}),e});setTimeout(()=>{RED.clipboard.import(),setTimeout(()=>{$("#red-ui-clipboard-dialog-import-text").val(JSON.stringify(e)).trigger("paste")},300)},400)}}

   // Add your plugin as a new tabsheet in the right sidebar AFTER the flow editor is completely started
   var initialiseConfigNodeOnce = () => {
      RED.events.off('runtime-state', initialiseConfigNodeOnce);

      // The html content of the sidebar has been specified below as a data-template, from where it can be loaded:
      var content = $($('script[type="text/x-red"][data-template-name="Screenshot"]').i18n().html());
    
      // Add a "Your sidebar" tabsheet to the right sidebar panel, in which this sidebar panel can be displayed
      // --> more details: https://nodered.org/docs/api/ui/sidebar/
      RED.sidebar.addTab({
         id: "Introspection",
         label: "Introspection", // short name for the tab
         name: "Introspection", // long name for the menu
         content: content,
         enableOnEdit: true,
         iconClass: "fa fa-camera" // your fontawesome icon
      });

      var tabs = RED.tabs.create({
            id: 'func-introspection-tabs',
            onchange: function(tab) {
               $('#func-introspection-tabs-content').children().hide();
               $('#' + tab.id).show();
            }
      });
      
      // Add first tab, screenshot
      tabs.addTab({
            id: 'func-introspection-tab-screenshot',
            iconClass: 'fa fa-photo',
            label: 'Screenshot'
      });
      
      // Add tab, orphans
      tabs.addTab({
            id: 'func-introspection-tab-lint',
            iconClass: 'fa fa-eyedropper',
            label: 'Lint'
      });

      // Add tab, obfuscation
      tabs.addTab({
            id: 'func-introspection-tab-obfuscation',
            iconClass: 'fa fa-user-secret',
            label: 'Obfuscation'
      });
      
      $('#node-input-obfuscation-generate-btn').on("click", function (e) {
         if ( e ) { e.preventDefault() }
         
         obfuscatieCurrentFlow({
            name: $('#node-input-obfuscate-name').is(":checked"),
            info: $('#node-input-obfuscate-info').is(":checked"),
            position: $('#node-input-obfuscate-position').is(":checked"),
            
            shrink_node: $('#node-input-obfuscate-shrink-size').is(":checked"),
            remove_groups: $('#node-input-obfuscate-remove-groups').is(":checked"),
            javascript: $('#node-input-obfuscate-javascript').is(":checked"),

            remove_junctions: $('#node-input-obfuscate-remove-junctions').is(":checked"),
            remove_icons: $('#node-input-obfuscate-remove-icons').is(":checked"),
            remove_debugs: $('#node-input-obfuscate-remove-debugs').is(":checked"),

            remove_linkout_nodes: $('#node-input-obfuscate-remove-linknodes').is(":checked"),
            copy_linkin_nodes: $('#node-input-obfuscate-copy-linkin-nodes').is(":checked"),
            ignore_off_flow_links: $('#node-input-obfuscate-ignore-off-flow-links').is(':checked'),
            remove_linkcall_nodes: $("#node-input-obfuscate-remove-linkcall-nodes").is(":checked"),

            replace_switch: $('#node-input-obfuscate-replace-switch').is(":checked"),
            replace_change: $('#node-input-obfuscate-replace-change').is(":checked"),

            add_license: $('#node-input-obfuscate-add-license-text').is(":checked"),
            append_license: $('#node-input-obfuscate-append-license-text').is(":checked"),
            license_text: $('#node-input-obfuscate-license-text').val(),
         })
      })

      $('#node-input-obfuscate-add-license-text').on('change', (e) => {
         if ( $('#node-input-obfuscate-add-license-text').is(":checked") ) {
            $('#node-input-obfuscate-add-license-text-row').fadeIn(300)
         } else {
            $('#node-input-obfuscate-add-license-text-row').fadeOut(300)
         }
      })

      $('#node-input-obfuscate-remove-linknodes').on('change', (e) => {
         if ( $('#node-input-obfuscate-remove-linknodes').is(":checked") ) {
            $('#node-input-obfuscate-coalesce-link-out-options').fadeIn(300)
         } else {
            $('#node-input-obfuscate-coalesce-link-out-options').fadeOut(300)
         }
      })

      $('#node-screenshot-capture-btn').on("click", function (e) {
         if ( e ) { e.preventDefault() }

         $('#node-screenshot-capture-btn').prop('disabled',true)
         $('#node-input-screenshot-svgcontainer').html( "" );

         RED.notify(
            "Please wait, screenshot being prepared ...", {
            type: "success"
            }
         );

         /*
            foreignObjects can be used to embed audio and videos into flow SVGs however
            they can't be exported since they cause an XML parsing error - unfortunately.
         */
         let opts = {
            rmidsandclasses: $('#node-input-screenshot-remove-classes-and-ids').is('checked'),
            removeforeignobjects: true // $('#node-input-screenshot-remove-foreign-objects').is(":checked")
         }
         
         generatorFunctionForVersion(RED, opts)( (svgdata) => {
            $('#node-input-screenshot-svgcontainer').html(svgdata);
            globalRefToSvgData = svgdata;
            setTimeout(() => {
               addPanZoom()
            },150)
            $('#node-screenshot-capture-btn').prop('disabled',false)
         });
      })

      $('#node-screenshot-post-svg-to-endpoint').on('click', (e) => {
         if (e) { e.preventDefault(); }
         let postEndpoint = $('#node-input-svgpost-endpoint').val() || "/screenshot"

         RED.notify(
            "Posting to endpoint ...", {
            type: "success"
            }
         );
         
         $.ajax({
            type: "POST",
            url: postEndpoint,
            dataType: "application/json;charset=utf-8",
            data: {
               d: globalRefToSvgData
            },
            complete: (obj) => {
               switch( obj.status ) {
               case 413:
               // apiMaxLength in the settings.js is set to 5mb by default,
               // if svg larger than that, need to increase the limit.
               // Provide a hint to that setting in the error message.
               RED.notify(
                  "Screenshot too large, increase apiMaxLength in settings.js.", {
                     type: "error"
                  }
               );
               break;
               case 404:
               // Http-in POST node is missing
               RED.notify(
                  "Missing http-in node: method: POST, path: " + postEndpoint, {
                     type: "error"
                  }
               );
               break;
               case 200:
                  RED.notify("Screenshot successfully posted", {
                     type: "success"
                  });
               break;
               default:
               RED.notify(
                  "Screenshot failed: " + obj.statusText + "  " + obj.status, {
                     type: "error"
                  }
               );
               };
            },
         });
         
      })

      // handle the download button under the editor window.
      $('#node-screenshot-download-svg').on("click", function (e) {
        if (e) { e.preventDefault(); }
        var svgBlob = new Blob([globalRefToSvgData], {type:"image/svg+xml;charset=utf-8"});
        var svgUrl = URL.createObjectURL(svgBlob);
        var downloadLink = document.createElement("a");
        downloadLink.href = svgUrl;
        downloadLink.download = "screenshot.svg";
        document.body.appendChild(downloadLink);
        downloadLink.click();
        document.body.removeChild(downloadLink);
      });

      $('#node-screenshot-copy-to-clipboard-svg').on("click", function (e) {
        if (e) { e.preventDefault(); }
        if ( RED.clipboard.copyText(globalRefToSvgData) ) {
          RED.notify("SVG copied to clipboard", { type: "success" });
        }
      });

      // When the user has entered new data in the sidebar, then store it into the config node
      $("#node-input-orphan-find-btn").on("click", function(e) {
         if ( e ) { e.preventDefault() }
         setupTreelist();
      })

      $('#node-input-documentation-find-btn').on('click', (e) => {
         if ( e ) { e.preventDefault() }
         setupTreelistInfoness();
      })

      $('#node-input-linkin-nodes-find-btn').on('click', (e) => {
         if ( e ) { e.preventDefault() }

         let linkNodes = (RED.view.selection().nodes || []).filter( (e) => {
            return e.type == "link in"
         }).map( e => e.id )

         if ( linkNodes.length == 0 ) {
            RED.notify(
               "No link in node selected, selected exactly one.", {
                  type: "error"
               }
            );
         } else {
            setupTreelistAllLinksForLinkIn(linkNodes[0])
         }
      })

      $('#node-input-orphan-clear-workspace-btn').on('click', (e) => {
         if ( e ) { e.preventDefault() }
         $('.red-ui-linkcall-link-indicator').remove()
         $('.red-ui-info-available-indicator').remove()
      })

      $('#node-input-msgtrace-clear-debug-btn').on('click', (e) => {
         if ( e ) { e.preventDefault() }

         // remove any message highlights from the debug panel
         $('.red-ui-debug-msg').css("background-color", "")

         // from [debug node](https://github.com/node-red/node-red/blob/2854351909dee9f92597faba3f37239134294eec/packages/node_modules/%40node-red/nodes/core/common/21-debug.html#L437)
         RED.actions.invoke("core:clear-debug-messages")
      })

      $('#node-input-msgtrace-clear-trace-btn').on('click', (e) => {
         if ( e ) { e.preventDefault() }
         setupTreeMsgTracerlist()
         $("#node-input-msgtracer-trace-treelist").treeList('empty')
         $("#node-input-msgtracer-trace-treelist").treeList('data', [])
      })

      $('#node-input-msgtracer-msgtodebug').on("change", toggleDebugTracingInBackend)
      $('#node-input-msgtracer-toggle').on("change", toggleMsgTracingInBackend)

      RED.actions.add( "introspection:show-link-call-links", highlightAllLinkCalls)

      // event is triggered by the unittesting node package, has no affect otherwise.
      RED.events.on( 'unittesting:server-restarted', () => {
         if ($('#node-input-msgtracer-toggle').is(":checked") ) {
            $('#node-input-msgtracer-toggle').trigger('click')
         }
         if ($('#node-input-msgtracer-msgtodebug').is(":checked")) {
            $('#node-input-msgtracer-msgtodebug').trigger('click')
         }
      })

      $('#node-input-linkcalls-find-btn').on('click', (e) => {
         if ( e ) { e.preventDefault() }
         highlightAllLinkCalls()
         
         /*
         try {
            $("#node-input-orphan-target-container-div").treeList('empty')
         } catch (ex) { }
         */
      })

      $('#node-input-transform-inject-to-change-btn').on( 'click', transformInjectToChangeNode)
      $('#node-input-statistics-btn').on('click', (e) => {
         if ( e ) { e.preventDefault() }
         setupTreeListForNodeStats()
      })

      RED.panels.create({
        id: 'func-introspection-tab-lint',
        resize: (topSze,botSze) => {
            $('#node-input-msgtracer-trace-treelist').parent().css("height", `calc(${botSze}px - 13vh)`)
            $('#node-input-orphan-target-container-div').parent().css('height', `calc(${topSze}px - 15vh)`)
        }
      })
   };
   RED.events.on('runtime-state', initialiseConfigNodeOnce);
})();
</script>

<style>
   .col-100 .red-ui-typedInput-container {
   width: 70% !important;
   }
   
   .col-100.no-label .red-ui-typedInput-container {
   width: 100% !important;
   }
   .w-30 {
      width: 40% !important;
      margin-left: 10px;
   }   
   .w-25 {
      width: 25% !important;
      margin-left: 10px;
   }   
   .ml-30 {
      margin-left: 30px !important;
   }
   .icon-button {
      height: 24px;
      width: 18px;
      display: inline-block;
      background-size: 100% 100%;
      top: 4px;
      position: relative;
   }
   .icon-button-text {
      position: relative;
      top: -4px;
   }

    svg g.tip {
        transition: transform 0.3s ease, fill-opacity 0.3s ease, stroke-opacity 0.3s ease;
        fill-opacity: 0.3;
        stroke-opacity: 0.3;
        cursor: pointer;
    }
    
    svg g.tip text {
        font-style="normal";
        font-size: 8px;
        font-family: sans-serif;
        stroke-width: 0.0;
        fill: #000;
        color: #000;
    }
    
    svg .tip rect {
      fill: lightyellow;
      stroke-width: 0.5;
      stroke: #000;
    }
    
    svg:hover g.tip:hover {
        transform: translatey(-6px);
        fill-opacity: 1;
        stroke-opacity: 1;
    }
</style>

<!-- The html for the right sidebar plugin screen -->
<script type="text/x-red" data-template-name="Screenshot">
<div class="form-row func-introspection-tabs-row">
   <ul style="min-width: 600px; margin-bottom: 20px;" id="func-introspection-tabs"></ul>
</div>

<div id="func-introspection-tabs-content" style="min-height: calc(100% - 95px);">

   <!-- Screenshot Tab in Sidebar -->

   <div id="func-introspection-tab-screenshot" style="display:none; min-height: calc(100%);">
      <div class="form-row">
         <div class="col-100">

            <div class="form-row" style="margin-left: 10px; margin-top: 30px;">
               <button type="button" id="node-screenshot-capture-btn"
                       class="red-ui-button red-ui-button-large"><i class="fa fa-camera"></i> Capture</button>
            </div>

            <div class="form-row" style="margin-left: 10px;">
               <label for="node-input-screenshot-remove-classes-and-ids" style="width: 200px">
                  <span>Remove Classes and Ids?</span>
               </label>
               <input type="checkbox" checked="checked" id="node-input-screenshot-remove-classes-and-ids"
                      style="display:inline-block; width:15px; vertical-align:baseline;">                          
            </div>
            
            <div class="form-row"
               style="min-height: 300px; height: 65vh; overflow: hidden; margin-left: 10px; margin-right: 15px; border: 1px rgb(196, 196, 196) solid; border-radius: 5px;">
               <div id="node-input-screenshot-svgcontainer"></div>
            </div>

            <div class="form-row" style="margin-left: 10px; margin-top: 30px;">
               <button type="button" id="node-screenshot-download-svg"
                          class="red-ui-button red-ui-button-large"><i class="fa fa-download"></i> Download</button>
               <button type="button" id="node-screenshot-copy-to-clipboard-svg"
                           class="red-ui-button red-ui-button-large"><i class="fa fa-clipboard"></i> Copy to Clipboard</button>
            </div>

            <div class="form-row" style="margin-left: 10px; margin-top: 30px;">
               <input type="text" id="node-input-svgpost-endpoint" placeholder="/screenshot" style="width: 40% !important;">
               <button type="button" id="node-screenshot-post-svg-to-endpoint"
                       class="red-ui-button red-ui-button-large"><i class="fa fa-send-o"></i> Post to Endpoint</button>
            </div>

         </div>
      </div>
   </div>

   <!-- Lint Tab in Sidebar -->

   <div id="func-introspection-tab-lint" style="display:none; min-height: calc(100%);">
      <div>
         <div class="form-row" style="margin-left: 10px; margin-top: 30px">
            <button id="node-input-orphan-find-btn"
                        class="red-ui-button"><i class="fa fa-life-ring"></i> Unconnected</button>
            <button id="node-input-documentation-find-btn"
                        class="red-ui-button"><i class="fa fa-cc"></i> Undocumented</button>
            <button id="node-input-linkin-nodes-find-btn"
                        class="red-ui-button"><i class="fa fa-link"></i> Link Ins</button>
            <button id="node-input-linkcalls-find-btn"
                        class="red-ui-button"><i class="fa fa-link"></i> Link Calls</button>
            <button id="node-input-orphan-clear-workspace-btn"
                        class="red-ui-button">Clear dots</button>
            <button id="node-input-transform-inject-to-change-btn"
                        class="red-ui-button"><i class='icon-button' style="background-image: url('icons/@gregoriusrippenstein/node-red-contrib-introspection/swap-inject-to-change.svg');"></i><span class='icon-button-text'>Inj-&gt;Chg</span></button>
            <button id="node-input-statistics-btn"
                       class="red-ui-button"><i class="fa fa-pie-chart"></i> Stats</button>
         </div>
   
         <div class="form-row"
            style="margin-left: 10px; position: relative; min-height: 5vh; height: 20vh; margin-right: 15px;">
            <div style="margin-bottom: 5px; width: 35%; padding-left: 60%;">
               <input type="text" id="node-input-orphan-target-filter" style="display: none;">
            </div>
            <div id="node-input-orphan-target-container-div"></div>
         </div>
      </div>
      
      <div>
         <!-- message tracing stuff -->
   
         <div class="form-row" style="margin-left: 10px; margin-top: 40px">
            <label for="node-input-msgtracer-toggle"  class="w-25">
               <i class="fa fa-stethoscope"></i>
               <span>Trace selected nodes?</span>
            </label>
            <input type="checkbox" id="node-input-msgtracer-toggle"
                   style="display:inline-block; width:15px; vertical-align:baseline;">
   
            <label for="node-input-msgtracer-toggle-all"  class="w-25">
               <i class="fa fa-warning"></i>
               <span>All nodes?</span>
            </label>
            <input type="checkbox" id="node-input-msgtracer-toggle-all"
                   style="display:inline-block; width:15px; vertical-align:baseline;">
   
            <button id="node-input-msgtrace-clear-trace-btn" style="margin-left: 10px;"
                          class="red-ui-button">Clear Trace</button>
         </div>
   
         <div class="form-row"
            style="margin-left: 10px; position: relative; min-height: 5vh; height: 20vh; margin-right: 15px;">
            <div style="margin-bottom: 5px; width: 35%; padding-left: 60%;">
               <input type="text" id="node-input-msgtracer-trace-treelist-filter" style="display: none;">
            </div>
            <div id="node-input-msgtracer-trace-treelist"></div>
         </div>
   
         <div class="form-row" style="margin-left: 10px; margin-top: 40px;">
            <label for="node-input-msgtracer-msgtodebug" class="w-25">
                        <i class="fa fa-bug"></i>
                        <span>Msgs from selected nodes to Debug?</span>
                  </label>
            <input type="checkbox" id="node-input-msgtracer-msgtodebug"
                         style="display:inline-block; width:15px; vertical-align:baseline;">
   
            <label for="node-input-msgtracer-msgtodebug-all" class="w-25">
                        <i class="fa fa-warning"></i>
                        <span>All nodes?</span>
                  </label>
            <input type="checkbox" id="node-input-msgtracer-msgtodebug-all"
                         style="display:inline-block; width:15px; vertical-align:baseline;">
   
            <button id="node-input-msgtrace-clear-debug-btn" style="margin-left: 10px;"
                                      class="red-ui-button">Clear Debug</button>
         </div>
      </div>
   </div>
   <!-- Obfuscation Tab in Sidebar -->

   <div id="func-introspection-tab-obfuscation" style="display:none; min-height: calc(100%);">

      <div class="form-row">
         <label for="node-input-obfuscate-name" class="w-30">
               <i class="fa fa-tag"></i>
               <span>Obfuscate Name?</span>
            </label>
         <input type="checkbox" id="node-input-obfuscate-name"
                     style="display:inline-block; width:15px; vertical-align:baseline;">
      </div>

      <div class="form-row">
         <label for="node-input-obfuscate-position" class="w-30">
               <i class="fa fa-map-pin"></i>
               <span>Obfuscate Position?</span>
            </label>
         <input type="checkbox" id="node-input-obfuscate-position"
                   style="display:inline-block; width:15px; vertical-align:baseline;">
      </div>

      <div class="form-row">
         <label for="node-input-obfuscate-shrink-size" class="w-30">
                        <i class="fa fa-angle-down"></i>
                        <span>Shrink Nodes?</span>
                     </label>
         <input type="checkbox" id="node-input-obfuscate-shrink-size"
                            style="display:inline-block; width:15px; vertical-align:baseline;">
      </div>

      <div class="form-row">
         <label for="node-input-obfuscate-javascript" class="w-30">
               <i class="fa fa-code"></i>
               <span>Obfuscate Javascript?</span>
            </label>
         <input type="checkbox" id="node-input-obfuscate-javascript"
                              style="display:inline-block; width:15px; vertical-align:baseline;">
      </div>

      <div class="form-row col-100">
         <label for="node-input-obfuscate-remove-icons" class="w-30">
               <i class="fa fa-adjust"></i>
               <span>Remove Icon?</span>
            </label>
         <input type="checkbox" id="node-input-obfuscate-remove-icons"
                              style="display:inline-block; width:15px; vertical-align:baseline;">
      </div>

      <div class="form-row">
         <label for="node-input-obfuscate-info" class="w-30">
               <i class="fa fa-info"></i>
               <span>Remove Info?</span>
            </label>
         <input type="checkbox" id="node-input-obfuscate-info"
                              style="display:inline-block; width:15px; vertical-align:baseline;">
      </div>

      <div class="form-row">
         <label for="node-input-obfuscate-remove-groups" class="w-30">
               <i class="fa fa-object-group"></i>
               <span>Remove Groups?</span>
            </label>
         <input type="checkbox" id="node-input-obfuscate-remove-groups"
                              style="display:inline-block; width:15px; vertical-align:baseline;">
      </div>

      <div class="form-row">
         <label for="node-input-obfuscate-remove-debugs" class="w-30">
               <i class="fa fa-bug"></i>
               <span>Remove comment & debugs?</span>
            </label>
         <input type="checkbox" id="node-input-obfuscate-remove-debugs"
                                       style="display:inline-block; width:15px; vertical-align:baseline;">
      </div>

      <div class="form-row">
         <label for="node-input-obfuscate-remove-junctions" class="w-30">
                        <i class="fa fa-sitemap"></i>
                        <span>Coalesce Junctions?</span>
                     </label>
         <input type="checkbox" id="node-input-obfuscate-remove-junctions"
                                       style="display:inline-block; width:15px; vertical-align:baseline;">
      </div>

      <div class="form-row">
         <label for="node-input-obfuscate-remove-linkcall-nodes" class="w-30">
                        <i class="fa fa-unlink"></i>
                        <span>Coalesce Link Call Nodes?</span>
                     </label>
         <input type="checkbox" id="node-input-obfuscate-remove-linkcall-nodes" style="display:inline-block; width:15px; vertical-align:baseline;">
      </div>

      <div class="form-row">
         <label for="node-input-obfuscate-remove-linknodes" class="w-30">
               <i class="fa fa-unlink"></i>
               <span>Coalesce Link Out Nodes?</span>
         </label>
         <input type="checkbox" id="node-input-obfuscate-remove-linknodes"
                              style="display:inline-block; width:15px; vertical-align:baseline;">
      </div>

      <div id="node-input-obfuscate-coalesce-link-out-options" style="display: none;">
         <div class="form-row">
            <label for="node-input-obfuscate-copy-linkin-nodes" class="ml-30" style="width: 150px;">
                  <span>Copy Link-In Nodes?</span>
            </label>
            <input type="checkbox" id="node-input-obfuscate-copy-linkin-nodes" style="display:inline-block; width:15px; vertical-align:baseline;">
         </div>
         <div class="form-row">
            <label for="node-input-obfuscate-ignore-off-flow-links" class="ml-30" style="width: 150px;">
                  <span>Ignore off-flow links?</span>
            </label>
            <input type="checkbox" id="node-input-obfuscate-ignore-off-flow-links" style="display:inline-block; width:15px; vertical-align:baseline;">
         </div>
      </div>

      <div class="form-row">
         <label class='w-30'>
                        <i class="fa fa-refresh"></i>
                        <span>Replace Nodes:</span>
                     </label>
      </div>

      <div class="form-row">
         <label for="node-input-obfuscate-replace-switch" class="ml-30">
                        <span>Switch</span>
                     </label>
         <input type="checkbox" id="node-input-obfuscate-replace-switch"
                            style="display:inline-block; width:15px; vertical-align:baseline;">
      </div>

      <div class="form-row">
         <label for="node-input-obfuscate-replace-change" class="ml-30">
                       <span>Change</span>
                     </label>
         <input type="checkbox" id="node-input-obfuscate-replace-change"
                                        style="display:inline-block; width:15px; vertical-align:baseline;">
      </div>

      <div class="form-row">
         <label for="node-input-obfuscate-add-license-text" class="w-30">
            <i class="fa fa-gavel"></i>
            <span>Replace info with license?</span>
         </label>
         <input type="checkbox" id="node-input-obfuscate-add-license-text" style="display:inline-block; width:15px; vertical-align:baseline;">
      </div>
      
      <div id="node-input-obfuscate-add-license-text-row" style="display: none;">
         <div class="form-row ml-30">
            <label for="node-input-obfuscate-append-license-text" style="width: 150px">
               <span>Append to info?</span>
            </label>
            <input type="checkbox" id="node-input-obfuscate-append-license-text" style="display:inline-block; width:15px; vertical-align:baseline;">
         </div>
         <div class="form-row ml-30">
            <textarea id="node-input-obfuscate-license-text" placeholder="License Text"></textarea>
         </div>
      </div>

      <div class="form-row">
         <div class="col-100">
            <div class="form-row node-input-target-row" style="margin-left: 10px; margin-top: 30px">
               <button id="node-input-obfuscation-generate-btn"
                                         class="red-ui-button"><i class="fa fa-low-vision"></i> Obfuscate</button>
            </div>
         </div>
      </div>

      <div class="form-row" style="margin-left: 10px">
         <b>Warning</b>: No guarantee is made that the obfuscated flow still works. This has not be
         thoroughly tested. Ensure correctness by completely testing the resultant obfuscated flow.
         No warranty of success is provided, implied or expressed.
      </div>
   </div>
</script>