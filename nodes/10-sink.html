<script type="text/javascript">
RED.nodes.registerType("Sink",{color:"#e5e4ef",icon:"font-awesome/fa-anchor",category:"introspection",paletteLabel:"Sink",defaults:{name:{value:""}},inputs:1,outputs:0,label:function(){return this.name||this._def.paletteLabel},labelStyle:function(){return this.name?"node_label_italic":""},oneditprepare:function(){var t=this;let o=1,i=(window._introSpectionsinkStack=[],window._introWorker=void 0,e=>{var n=RED.nodes.node(e[e.length-1]);let t=[];return e.forEach(function(e){var n,e=RED.nodes.node(e)||RED.nodes.junction(e);void 0!==e&&(n=RED.nodes.workspace(e.z)||RED.nodes.subflow(e.z),t.push({label:"",_label:RED.utils.getNodeLabel(e),node:e,sublabel:n&&RED.utils.getNodeLabel(n)||e.z,icon:RED.utils.createNodeIcon(e,!0),class:"intro-remove-top-left"}))}),{node:n,label:RED.utils.getNodeLabel(n),_label:RED.utils.getNodeLabel(n),_pathlen:e.length,sublabel:"Length: "+e.length,selected:!1,checkbox:!1,children:t}});var a=$("#node-input-sink-target-filter").searchBox({style:"compact",delay:300,change:function(){let n=$(this).val().trim().toLowerCase();var e,t=$("#node-input-sink-target-container-div").treeList("data");""===n?($("#node-input-sink-target-container-div").treeList("filter",null),a.searchBox("count","")):(e=$("#node-input-sink-target-container-div").treeList("filter",function(e){return-1<e._label.toLowerCase().indexOf(n)||-1<e.node.type.toLowerCase().indexOf(n)||e.sublabel.toLowerCase().indexOf(n)}),a.searchBox("count",e+" / "+t.length))}}),l=($("#node-input-sink-target-container-div").css({width:"100%",height:"95%"}).treeList({multi:!1}).on("treelistitemmouseover",function(e,n){}).on("treelistitemmouseout",function(e,n){}).on("treelistconfirm",function(e,n){n.node&&!n.children&&(RED.view.reveal(n.node.id),RED.view.select(n.node.id),setTimeout(()=>{RED.editor.edit(n.node)},100))}).on("treelistselect",function(e,n){n.node&&!n.children&&(RED.workspaces.show(n.node.z,!1,!1,!0),RED.view.reveal(n.node.id,!0),RED.view.redraw())}),function(n,t){if(t.indexOf(n.id)<0&&!n.d)switch(n.type){case"link in":n.links.forEach(e=>{e=RED.nodes.node(e);e&&l(e,[...t,n.id])});break;case"Seeker":t.push(n.id),window._introSpectionsinkStack=[t,...window._introSpectionsinkStack];break;default:RED.nodes.getNodeLinks(n,o).forEach(e=>{l(e.source,[...t,n.id])})}});let s=e=>{e&&e.preventDefault();let n=window._introSpectionsinkStack.length,t=25,o=("-"!=$("#node-input-sink-show-percent").val()&&(t=parseInt(n*(parseInt($("#node-input-sink-show-percent").val())/100))),e=$("#node-input-sink-show-ordering").val(),{1:(e,n)=>e.length<n.length?-1:1,2:(e,n)=>e.length>n.length?-1:1,3:(e,n)=>RED.utils.getNodeLabel(RED.nodes.node(e[e.length-1]))<RED.utils.getNodeLabel(RED.nodes.node(n[n.length-1]))?-1:1,4:(e,n)=>{e=RED.utils.getNodeLabel(RED.nodes.node(e[e.length-1]));return RED.utils.getNodeLabel(RED.nodes.node(n[n.length-1]))<e?-1:1},5:(e,n)=>.5<Math.random()?-1:1}[parseInt(e)]||((e,n)=>e.length<n.length?-1:1));setTimeout(()=>{setTimeout(()=>{$("#node-input-sink-totalPaths").html(t>n?""+n:t+" / "+n)},10),setTimeout(()=>{$("#node-input-sink-target-container-div").treeList("data",window._introSpectionsinkStack.sort(o).slice(0,t).map(e=>i(e)))},20)},100)},d=()=>{let e=window._introSpectionsinkStack.length;setTimeout(()=>{$("#node-input-sink-start-but").prop("disabled",!1),$("#node-input-sink-totalPaths").html(e),$("#node-input-sink-spinner").hide()},10);var n="sink",t=e;$(`#node-input-${n}-show-percent`).show(),$(`#node-input-${n}-show-ordering`).show();var o,i=$(`#node-input-${n}-show-percent`),a=(i.html(""),i.append($("<option></option>").val("-").html("Show..")),[5,10,20,30,40,50,75].forEach(e=>{var n=parseInt(e*t/100);0!=n&&i.append($("<option></option>").val(e).html(n+" paths"))}),i.append($("<option></option>").val(100).html("All")),i.val("-"),(i=$(`#node-input-${n}-show-ordering`)).html(""),{"Count Asc":1,"Count Desc":2,"Name Asc":3,"Name Desc":4,Random:5});for(o in a)i.append($("<option></option>").val(a[o]).html(o));i.val(1),$("#node-input-sink-show-ordering").on("change",s),$("#node-input-sink-show-percent").on("change",s),$("#node-input-sink-show-percent").trigger("change")};$("#node-input-sink-show-pathway-but").on("click",e=>{var n=$("#node-input-sink-target-container-div").treeList("data").filter(e=>e.expanded);1==(n=n).length?(n=n[0].children.filter(e=>e.node.z==RED.workspaces.active()).map(e=>e.node.id),RED.tray.hide(),RED.view.selectNodes({selected:n,onselect:()=>{RED.tray.show()},oncancel:()=>{RED.tray.show()}})):RED.notify("Only one expanded pathway can be shown.",{type:"warning"})}),$("#node-input-sink-start-but").on("click",e=>{if(e&&e.preventDefault(),setTimeout(()=>{$("#node-input-sink-start-but").prop("disabled",!0),$("#node-input-sink-totalPaths").html(""),$("#node-input-sink-spinner").show(),$("#node-input-sink-show-percent").hide(),$("#node-input-sink-show-ordering").hide()},10),window._introSpectionsinkStack=[],"undefined"!=typeof Worker){let n=new Worker("data:text/javascript;base64,bGV0IGludHJvU3BlY3Rpb25TdGFjaz1bXSxncmFwaD1bXSxncmFwaEluZGV4PXt9LFJFRD17bm9kZXM6e25vZGU6ZT0+Z3JhcGhbZ3JhcGhJbmRleFtlXV0sZ2V0Tm9kZUxpbmtzOnM9PnMuaW53aXJlcy5tYXAoZT0+KHt0YXJnZXQ6cyxzb3VyY2U6UkVELm5vZGVzLm5vZGUoZSl9KSl9fTt2YXIgdHJhdmVyc2U9ZnVuY3Rpb24ocyxhKXtpZihhLmluZGV4T2Yocy5pZCk8MCYmIXMuZClzd2l0Y2gocy50eXBlKXtjYXNlImxpbmsgaW4iOnMubGlua3MuZm9yRWFjaChlPT57ZT1SRUQubm9kZXMubm9kZShlKTtlJiZ0cmF2ZXJzZShlLFsuLi5hLHMuaWRdKX0pO2JyZWFrO2Nhc2UiU2Vla2VyIjphLnB1c2gocy5pZCkscG9zdE1lc3NhZ2UoYSk7YnJlYWs7ZGVmYXVsdDpSRUQubm9kZXMuZ2V0Tm9kZUxpbmtzKHMpLmZvckVhY2goZT0+e3RyYXZlcnNlKGUuc291cmNlLFsuLi5hLHMuaWRdKX0pfX07b25tZXNzYWdlPWZ1bmN0aW9uKGUpe2xldCBzPWUuZGF0YS5zaW5rSWQ7KGdyYXBoPShncmFwaD1lLmRhdGEubm9kZXMubWFwKGU9Pih7d2lyZXM6ZS53aXJlcyxsaW5rczplLmxpbmtzLGQ6ZS5kaXNhYmxlZHx8ZS5kLGlkOmUuaWQsdHlwZTplLnR5cGV9KSkuZmlsdGVyKGU9PiEhZS53aXJlcykubWFwKGU9PihlLmZsYXR3aXJlcz1lLndpcmVzLmZsYXQoKSxlKSkpLm1hcChzPT4ocy5pbndpcmVzPWdyYXBoLmZpbHRlcihlPT4tMTxlLmZsYXR3aXJlcy5pbmRleE9mKHMuaWQpKS5tYXAoZT0+ZS5pZCkscykpKS5mb3JFYWNoKChlLHMpPT5ncmFwaEluZGV4W2UuaWRdPXMpLFJFRC5ub2Rlcy5nZXROb2RlTGlua3MoUkVELm5vZGVzLm5vZGUocykpLmZvckVhY2goZT0+e3RyYXZlcnNlKGUuc291cmNlLFtzXSl9KSxwb3N0TWVzc2FnZSgiZG9uZSIpfTs=");(window._introWorker=n).onmessage=function(e){"done"==e.data?(n.terminate(),delete window._introWorker,d()):(window._introSpectionsinkStack.push(e.data),$("#node-input-sink-totalPaths").html(window._introSpectionsinkStack.length),26==window._introSpectionsinkStack.length&&$("#node-input-sink-target-container-div").treeList("data",window._introSpectionsinkStack.sort((e,n)=>e.length<n.length?-1:1).slice(0,25).map(e=>i(e))))},setTimeout(()=>{n.postMessage({sinkId:t.id,nodes:RED.nodes.createCompleteNodeSet({credentials:!1})})},10)}else setTimeout(()=>{RED.nodes.getNodeLinks(t,o).forEach(e=>{l(e.source,[t.id])}),d()},300)})},oneditsave:function(){window._introWorker&&(window._introWorker.terminate(),delete window._introWorker),delete window._introSpectionsinkStack},oneditcancel:function(){window._introWorker&&(window._introWorker.terminate(),delete window._introWorker),delete window._introSpectionsinkStack},oneditresize:function(e){for(var n=$("#dialog-form>div:not(.node-input-target-list-row)"),t=$("#dialog-form").height(),o=0;o<n.length;o++)t-=$(n[o]).outerHeight(!0);$("#dialog-form>div.node-input-target-list-row").css("height",t+"px")}});
</script>

<script type="text/html" data-template-name="Sink">
  <div class="form-row">
    <label for="node-input-name"><i class="fa fa-tag"></i> <span data-i18n="common.label.name">Name</span></label>
    <input type="text" id="node-input-name" placeholder="Name">
  </div>

  <div class="form-row node-input-target-row">
    <button id="node-input-sink-start-but" class="red-ui-button"><i class="fa fa-refresh"></i> Find Pathways</button>
    <select class='hide' style="width:100px;" id="node-input-sink-show-percent"></select>
    <select class='hide' style="width:100px;" id="node-input-sink-show-ordering"></select>
    <button id="node-input-sink-show-pathway-but" class="red-ui-button">Show Pathway</button>
  </div>

  <div class="form-row node-input-target-row node-input-target-list-row" style="margin-top: 40px; position: relative; min-height: 100px">
    <div style="position: absolute; top: -30px; right: 0;"><input type="text" id="node-input-sink-target-filter"></div>

    <div id="node-input-sink-target-container-div"></div>
  </div>

  <div class="form-row" style="margin-top: -40px;">
    <label>Total Paths: 
        <span id="node-input-sink-totalPaths"></span><img id="node-input-sink-spinner" class="hide" src='red/images/spin.svg'/>
    </label>
  </div>
</script>

<style>
  .intro-remove-top-left i.red-ui-palette-icon-fa {
    top: -2px !important;
    left: 0px !important;
  }
</style>

<script type="text/html" data-help-name="Sink">
  <p>Sink is the end of a chain of nodes to complete a full text.</p>
</script>
