<script type="text/javascript">
RED.nodes.registerType("Seeker",{color:"#e5e4ef",icon:"font-awesome/fa-ship",category:"introspection",paletteLabel:"Seeker",defaults:{name:{value:""}},inputs:0,outputs:1,label:function(){return this.name||this._def.paletteLabel},labelStyle:function(){return this.name?"node_label_italic":""},oneditprepare:function(){var g=this,o=(window._introSpectionSeekerStack=[],window._introWorker=void 0,$("#node-input-seeker-target-filter").searchBox({style:"compact",delay:300,change:function(){let t=$(this).val().trim().toLowerCase();var e,g=$("#node-input-seeker-target-container-div").treeList("data");""===t?($("#node-input-seeker-target-container-div").treeList("filter",null),o.searchBox("count","")):(e=$("#node-input-seeker-target-container-div").treeList("filter",function(e){return-1<e._label.toLowerCase().indexOf(t)||-1<e.node.type.toLowerCase().indexOf(t)||e.sublabel.toLowerCase().indexOf(t)}),o.searchBox("count",e+" / "+g.length))}}));$("#node-input-seeker-target-container-div").css({width:"100%",height:"95%"}).treeList({multi:!1}).on("treelistitemmouseover",function(e,t){}).on("treelistitemmouseout",function(e,t){}).on("treelistconfirm",function(e,t){t.node&&!t.children&&(RED.view.reveal(t.node.id),RED.view.select(t.node.id),setTimeout(()=>{RED.editor.edit(t.node)},100))}).on("treelistselect",function(e,t){var g;t.node&&(t.children?(g=t.children.filter(e=>e.node.z==RED.workspaces.active()).map(e=>e.node.id),RED.tray.hide(),RED.view.selectNodes({selected:g,onselect:()=>{RED.tray.show()},oncancel:()=>{RED.tray.show()}})):(RED.workspaces.show(t.node.z,!1,!1,!0),RED.view.reveal(t.node.id,!0),RED.view.redraw()))});let n=e=>{var t=RED.nodes.node(e[e.length-1]);let g=[];return e.forEach(function(e){var t,e=RED.nodes.node(e)||RED.nodes.junction(e);void 0!==e&&(t=RED.nodes.workspace(e.z)||RED.nodes.subflow(e.z),g.push({label:"",_label:RED.utils.getNodeLabel(e),node:e,sublabel:t&&RED.utils.getNodeLabel(t)||e.z,icon:RED.utils.createNodeIcon(e,!0),class:"intro-remove-top-left"}))}),{node:t,label:RED.utils.getNodeLabel(t),_label:RED.utils.getNodeLabel(t),_pathlen:e.length,sublabel:"Length: "+e.length,selected:!1,checkbox:!1,children:g}};var i=function(t,g){if(g.indexOf(t.id)<0&&!t.d)switch(t.type){case"link call":RED.nodes.getNodeLinks(t).forEach(e=>{i(e.target,[...g,t.id])}),t.links.forEach(e=>{e=RED.nodes.node(e);e&&i(e,[...g,t.id])});break;case"link out":t.links.forEach(e=>{e=RED.nodes.node(e);e&&i(e,[...g,t.id])});break;case"Sink":g.push(t.id),window._introSpectionSeekerStack=[g,...window._introSpectionSeekerStack];break;default:RED.nodes.getNodeLinks(t).forEach(e=>{i(e.target,[...g,t.id])})}};let C=()=>{var t,e=window._introSpectionSeekerStack.length;$("#node-input-seeker-start-but").prop("disabled",!1),$("#node-input-seeker-totalPaths").html(e),$("#node-input-seeker-spinner").hide(),50<e?($("#node-input-seeker-show-percent").show(),(t=$("#node-input-seeker-show-percent")).html(""),["-",5,10,20,30,40,50,75,100].forEach(function(e){t.append($("<option></option>").val(e).html(100==e?"All":"-"==e?"Select..":e+"%"))}),t.val("-"),$("#node-input-seeker-show-percent").on("change",e=>{e&&e.preventDefault();e=window._introSpectionSeekerStack.length;let t=25;"-"!=$("#node-input-seeker-show-percent").val()&&(t=parseInt(e*(parseInt($("#node-input-seeker-show-percent").val())/100))),$("#node-input-seeker-totalPaths").html(t+" / "+e),setTimeout(()=>{$("#node-input-seeker-target-container-div").treeList("data",window._introSpectionSeekerStack.sort((e,t)=>e.length<t.length?-1:1).slice(0,t).map(e=>n(e)))},300)}),$("#node-input-seeker-show-percent").trigger("change")):setTimeout(()=>{$("#node-input-seeker-target-container-div").treeList("data",window._introSpectionSeekerStack.sort((e,t)=>e.length<t.length?-1:1).map(e=>n(e)))},300)};$("#node-input-seeker-start-but").on("click",e=>{if(e&&e.preventDefault(),$("#node-input-seeker-start-but").prop("disabled",!0),$("#node-input-seeker-totalPaths").html(""),$("#node-input-seeker-spinner").show(),window._introSpectionSeekerStack=[],"undefined"!=typeof Worker){let t=new Worker("data:text/javascript;base64,bGV0IGludHJvU3BlY3Rpb25TdGFjayA9IFtdOwpsZXQgZ3JhcGggPSBbXTsKbGV0IGdyYXBoSW5kZXggPSB7fTsKCmxldCBSRUQgPSB7CiAgICBub2RlczogewogICAgICAgIG5vZGU6IChpZCkgPT4gewogICAgICAgICAgICByZXR1cm4gZ3JhcGhbZ3JhcGhJbmRleFtpZF1dCiAgICAgICAgfSwKCiAgICAgICAgZ2V0Tm9kZUxpbmtzOiAobmRlKSA9PiB7CiAgICAgICAgICAgIHJldHVybiBuZGUud2lyZXMuZmxhdCgpLm1hcCh3ID0+IHsKICAgICAgICAgICAgICAgIHJldHVybiB7CiAgICAgICAgICAgICAgICAgICAgInRhcmdldCI6IFJFRC5ub2Rlcy5ub2RlKHcpLAogICAgICAgICAgICAgICAgICAgICJzb3VyY2UiOiBuZGUKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfSkKICAgICAgICB9CiAgICB9Cn07CgpsZXQgdHJhdmVyc2UgPSBmdW5jdGlvbiAobm9kZSwgbm9kZUlkcykgewogICAgaWYgKG5vZGVJZHMuaW5kZXhPZihub2RlLmlkKSA8IDAgJiYgIW5vZGUuZCkgewogICAgICAgIHN3aXRjaCAobm9kZS50eXBlKSB7CgogICAgICAgICAgICBjYXNlICJsaW5rIGNhbGwiOgogICAgICAgICAgICAgICAgUkVELm5vZGVzLmdldE5vZGVMaW5rcyhub2RlKS5mb3JFYWNoKGwgPT4gewogICAgICAgICAgICAgICAgICAgIHRyYXZlcnNlKGwudGFyZ2V0LCBbLi4ubm9kZUlkcywgbm9kZS5pZF0pOwogICAgICAgICAgICAgICAgfSk7CgogICAgICAgICAgICAgICAgbm9kZS5saW5rcy5mb3JFYWNoKChsbmtOZGVJZCkgPT4gewogICAgICAgICAgICAgICAgICAgIHZhciBkTm9kZSA9IFJFRC5ub2Rlcy5ub2RlKGxua05kZUlkKTsKICAgICAgICAgICAgICAgICAgICBpZiAoIWROb2RlKSB7IHJldHVybiB9OwoKICAgICAgICAgICAgICAgICAgICB0cmF2ZXJzZShkTm9kZSwgWy4uLm5vZGVJZHMsIG5vZGUuaWRdKTsKICAgICAgICAgICAgICAgIH0pOwoKICAgICAgICAgICAgICAgIGJyZWFrOwoKICAgICAgICAgICAgY2FzZSAibGluayBvdXQiOgogICAgICAgICAgICAgICAgbm9kZS5saW5rcy5mb3JFYWNoKChsbmtOZGVJZCkgPT4gewogICAgICAgICAgICAgICAgICAgIHZhciBkTm9kZSA9IFJFRC5ub2Rlcy5ub2RlKGxua05kZUlkKTsKICAgICAgICAgICAgICAgICAgICBpZiAoIWROb2RlKSB7IHJldHVybiB9OwoKICAgICAgICAgICAgICAgICAgICB0cmF2ZXJzZShkTm9kZSwgWy4uLm5vZGVJZHMsIG5vZGUuaWRdKTsKICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICAgICAgYnJlYWs7CgogICAgICAgICAgICBjYXNlICJTaW5rIjoKICAgICAgICAgICAgICAgIG5vZGVJZHMucHVzaChub2RlLmlkKTsKICAgICAgICAgICAgICAgIHBvc3RNZXNzYWdlKG5vZGVJZHMpOwogICAgICAgICAgICAgICAgYnJlYWs7CgogICAgICAgICAgICBkZWZhdWx0OgogICAgICAgICAgICAgICAgUkVELm5vZGVzLmdldE5vZGVMaW5rcyhub2RlKS5mb3JFYWNoKGwgPT4gewogICAgICAgICAgICAgICAgICAgIHRyYXZlcnNlKGwudGFyZ2V0LCBbLi4ubm9kZUlkcywgbm9kZS5pZF0pOwogICAgICAgICAgICAgICAgfSkKICAgICAgICB9CiAgICB9Cn07Cgpvbm1lc3NhZ2UgPSBmdW5jdGlvbiAoZXZlbnQpIHsKICAgIGxldCBzZWVrZXJJZCA9IGV2ZW50LmRhdGEuc2Vla2VySWQ7CiAgICBncmFwaCA9IGV2ZW50LmRhdGEuZ3JhcGg7CgogICAgZ3JhcGguZm9yRWFjaCgodiwgaWR4KSA9PiBncmFwaEluZGV4W3YuaWRdID0gaWR4KTsKCiAgICBSRUQubm9kZXMuZ2V0Tm9kZUxpbmtzKFJFRC5ub2Rlcy5ub2RlKHNlZWtlcklkKSkuZm9yRWFjaCgobCkgPT4gewogICAgICAgIHRyYXZlcnNlKGwudGFyZ2V0LCBbc2Vla2VySWRdKQogICAgfSk7CgogICAgcG9zdE1lc3NhZ2UoImRvbmUiKQp9Cg=="),e=((window._introWorker=t).onmessage=function(e){"done"==e.data?(t.terminate(),delete window._introWorker,C()):(window._introSpectionSeekerStack.push(e.data),$("#node-input-seeker-totalPaths").html(window._introSpectionSeekerStack.length),26==window._introSpectionSeekerStack.length&&$("#node-input-seeker-target-container-div").treeList("data",window._introSpectionSeekerStack.sort((e,t)=>e.length<t.length?-1:1).slice(0,25).map(e=>n(e))))},RED.nodes.createCompleteNodeSet({credentials:!1}));e=e.map(e=>({wires:e.wires,links:e.links,d:e.disabled||e.d,id:e.id,type:e.type})).filter(e=>!!e.wires),t.postMessage({seekerId:g.id,graph:e})}else setTimeout(()=>{RED.nodes.getNodeLinks(g).forEach(e=>{i(e.target,[g.id])}),C()},300)})},oneditsave:function(){window._introWorker&&(window._introWorker.terminate(),delete window._introWorker),delete window._introSpectionSeekerStack},oneditcancel:function(){window._introWorker&&(window._introWorker.terminate(),delete window._introWorker),delete window._introSpectionSeekerStack},oneditresize:function(e){for(var t=$("#dialog-form>div:not(.node-input-target-list-row)"),g=$("#dialog-form").height(),o=0;o<t.length;o++)g-=$(t[o]).outerHeight(!0);$("#dialog-form>div.node-input-target-list-row").css("height",g+"px")}});
</script>

<script type="text/html" data-template-name="Seeker">

  <div class="form-row">
    <label for="node-input-name"><i class="fa fa-tag"></i> <span data-i18n="common.label.name">Name</span></label>
    <input type="text" id="node-input-name" placeholder="Name">
  </div>

  <div class="form-row node-input-target-row">
    <button id="node-input-seeker-start-but" class="red-ui-button"><span><i class="fa fa-refresh"></i> Find Pathways</span></button>
    <select class='hide' id="node-input-seeker-show-percent"></select>
  </div>

  <div class="form-row node-input-target-row node-input-target-list-row" style="margin-top: 40px; position: relative; min-height: 100px">
    <div style="position: absolute; top: -30px; right: 0;"><input type="text" id="node-input-seeker-target-filter"></div>

    <div id="node-input-seeker-target-container-div"></div>
  </div>

  <div class="form-row" style="margin-top: -40px;">
    <label>Total Paths: 
        <span id="node-input-seeker-totalPaths"></span><img class='hide' id="node-input-seeker-spinner" src='red/images/spin.svg'/>
    </label>
  </div>

</script>

<style>
  .intro-remove-top-left i.red-ui-palette-icon-fa {
    top: -2px !important;
    left: 0px !important;
  }
</style>

<script type="text/html" data-help-name="Seeker">
  <p>The Seeker seeks in the sink and presents all (max 25) paths that lead to the sink.</p>
</script>
