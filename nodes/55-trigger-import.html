<script type="text/javascript">
  RED.comms.subscribe('introspect:trigger-import-tripped', (event,data) => {
    if ( data.msg == "import-flow" ) {
      var content = data.flowContent;

      if ( data.removeduplicates ) {
        content = content.filter( (elem) => {
          return RED.nodes.node(elem.id) == undefined
        });
      }

      if ( content.length == 0 ) {
        RED.notify("No new content", {
          type: "ok",
          id: "TriggerImport",
          timeout: 2000
        });
        return;
      }
      RED.clipboard.import();

      setTimeout( () => {
        $('#red-ui-clipboard-dialog-import-text').val(
          JSON.stringify(content)
        ).trigger("paste");

        if ( data.autoimport ) {
          setTimeout( () => {
            $('#red-ui-clipboard-dialog-ok').trigger('click');
          }, 435);
        }
      }, 300);
    }
  });

  RED.nodes.registerType('TriggerImport',{
    color: '#e5e4ef',
    icon: "icons/subflow.svg",
    category: 'introspection',
    paletteLabel: "TriggerImport",
    defaults: {
      name: {
        value:"",
      },
      autoimport: {
        value: false
      },
      removeduplicates: {
        value: false
      },
    },
    inputs:1,
    outputs:1,

    label: function() {
      return (this.name || this._def.paletteLabel);
    },

    labelStyle: function() {
      return this.name?"node_label_italic":"";
    },
  });
</script>

<script type="text/html" data-template-name="TriggerImport">
  <div class="form-row">
      <label for="node-input-name">
          <i class="fa fa-tag"></i>
          <span data-i18n="common.label.name">Name</span>
      </label>
      <input type="text" id="node-input-name" placeholder="Name">
  </div>

  <div class="form-row">
      <label for="node-input-autoimport" style="width: 150px !important;">
        <span>Automatic Import?</span>
      </label>
      <input type="checkbox"
             id="node-input-autoimport"
             style="display:inline-block; width:15px; vertical-align:baseline;">
  </div>

  <div class="form-row">
      <label for="node-input-removeduplicates" style="width: 150px !important;">
        <span>Remove duplicates?</span>
      </label>
      <input type="checkbox"
             id="node-input-removeduplicates"
             style="display:inline-block; width:15px; vertical-align:baseline;">
  </div>

</script>

<script type="text/html" data-help-name="TriggerImport">
  <p>Trigger import opens the flow import dialog with data that came from the server.</p>
</script>
